<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cepte Not (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Ä°konlarÄ± -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc;
        }
        .main-container {
            max-width: 900px;
            margin: auto;
        }
        
        /* Arka plan gradient */
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Modal Stilleri */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: all 0.3s ease;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        .modal-backdrop.open {
            opacity: 1;
        }
        .modal-backdrop.open .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Not KartÄ± Animasyonu */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .note-card {
            animation: fadeIn 0.3s ease-out;
            transition: all 0.3s ease-out;
            word-break: break-word;
            /* GÃœNCELLENDÄ°: Sol kenar ÅŸeridi iÃ§in */
            border-left-width: 5px; 
            border-top-width: 1px;
            border-right-width: 1px;
            border-bottom-width: 1px;
        }
        .note-card.exiting {
            opacity: 0;
            transform: scale(0.95);
        }
        
        /* Kategori Filtre ButonlarÄ± */
        .category-filter {
            transition: all 0.2s ease;
        }
        .category-filter.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Floating Action Button */
        .fab {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* Kategori Renkleri (Sadece Etiket ve Filtre iÃ§in) */
        .cat-label-Ä°ÅŸ { background-color: #3b82f6; }
        .cat-label-KiÅŸisel { background-color: #10b981; }
        .cat-label-Market { background-color: #f59e0b; }
        
        .cat-filter-Ä°ÅŸ.active { background-color: #3b82f6; color: white; }
        .cat-filter-KiÅŸisel.active { background-color: #10b981; color: white; }
        .cat-filter-Market.active { background-color: #f59e0b; color: white; }

        /* YENÄ°: Ã–ncelik Renkleri (Kenar ÅŸeridi iÃ§in) */
        .priority-YÃ¼ksek { border-color: #ef4444; } /* KÄ±rmÄ±zÄ± */
        .priority-Normal { border-color: #3b82f6; } /* Mavi */
        .priority-DÃ¼ÅŸÃ¼k { border-color: #6b7280; } /* Gri */

    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Ana Konteyner -->
    <div class="main-container">
    
        <!-- Header -->
        <header class="p-6 header-gradient text-white text-center rounded-2xl shadow-lg relative mb-8">
            <h1 class="text-2xl md:text-3xl font-bold">Cepte Not</h1>
            <p class="text-xs text-white opacity-75 mt-1">Â© GÃ¶khan ELGÃœL tarafÄ±ndan tasarlanmÄ±ÅŸtÄ±r.</p>
            <div id="status-indicator" class="absolute top-4 right-4 text-xs font-semibold px-2 py-1 rounded-full opacity-0 transition-opacity"></div>
        </header>

        <!-- YENÄ°: Arama Ã‡ubuÄŸu -->
        <div class="mb-8 relative">
            <input type="search" id="search-input" placeholder="Notlarda ara..." class="w-full p-4 pl-12 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            <i data-lucide="search" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>

        <!-- Kategori Filtreleri -->
        <div id="category-filters" class="flex flex-wrap justify-center gap-3 mb-8">
            <!-- Kategori filtreleri buraya eklenecek -->
        </div>

        <!-- Not Listesi (Kartlar) -->
        <div id="note-list-container">
            <ul id="note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Not kartlarÄ± JavaScript ile doldurulacak -->
            </ul>
        </div>
        
        <!-- HatÄ±rlatma KartlarÄ± AlanÄ± -->
        <div id="reminders-container" class="mt-8 space-y-4">
            <!-- HatÄ±rlatma kartlarÄ± buraya eklenecek -->
        </div>
        
        <!-- Global Tamamlanan Notlar AlanÄ± -->
        <div id="global-completed-container" class="mt-8">
            <div id="completed-notes-accordion" class="bg-white p-4 rounded-lg shadow-md hidden">
                <button id="completed-notes-toggle" class="w-full flex justify-between items-center text-left text-gray-700 font-semibold">
                    <span>Tamamlanan Notlar (TÃ¼mÃ¼)</span>
                    <div class="flex items-center">
                        <span id="completed-count" class="text-sm bg-gray-200 text-gray-700 rounded-full px-2.5 py-0.5 mr-2">0</span>
                        <i data-lucide="chevron-down" id="completed-chevron" class="w-5 h-5 transition-transform"></i>
                    </div>
                </button>
                <div id="completed-notes-panel" class="hidden mt-4 pt-4 border-t">
                    <ul id="completed-note-list" class="space-y-2">
                        <!-- Tamamlanan notlar buraya gelecek -->
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- Not Ekle Butonu (FAB) -->
    <button id="open-add-note-modal" class="fab w-16 h-16 rounded-full fixed bottom-8 right-8 flex items-center justify-center text-white shadow-xl z-40">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>
    
    <!-- Not Ekleme ModalÄ± -->
    <div id="add-note-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0 hidden">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Yeni Not Ekle</h3>
            <div class="flex flex-col gap-4">
                <textarea id="note-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Yeni bir not ekle..." rows="3"></textarea>
                
                <div class="flex items-center gap-4">
                    <label for="image-input" class="cursor-pointer p-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i>
                        <span>Resim SeÃ§ (Max 250KB)</span>
                    </label>
                    <input type="file" id="image-input" class="hidden" accept="image/*">
                    <div id="image-preview-container" class="hidden items-center gap-2">
                        <img id="image-preview" src="" alt="Resim Ã–nizleme" class="w-12 h-12 object-cover rounded-lg border">
                        <button id="remove-image-btn" class="p-1 text-red-500 hover:bg-red-100 rounded-full" title="Resmi KaldÄ±r">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="date" id="note-date-input" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 sm:w-1/2">
                    <select id="note-category-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white sm:w-1/2">
                        <option value="Ä°ÅŸ">Ä°ÅŸ</option>
                        <option value="KiÅŸisel" selected>KiÅŸisel</option>
                        <option value="Market">Market</option>
                    </select>
                </div>
                
                <!-- YENÄ°: Ã–ncelik Ekleme -->
                <select id="note-priority-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                    <option value="Normal" selected>Ã–ncelik: Normal</option>
                    <option value="YÃ¼ksek">Ã–ncelik: YÃ¼ksek</option>
                    <option value="DÃ¼ÅŸÃ¼k">Ã–ncelik: DÃ¼ÅŸÃ¼k</option>
                </select>

            </div>
            <div class="mt-6 flex justify-between items-center">
                <button id="start-speech-btn" class="p-3 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition" title="Sesli Not Ekle">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>
                <div class="space-x-3">
                    <button id="cancel-add-note-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Ä°ptal</button>
                    <button id="add-note-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- YENÄ°: Not DÃ¼zenleme ModalÄ± -->
    <div id="edit-note-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0 hidden">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Notu DÃ¼zenle</h3>
            <div class="flex flex-col gap-4">
                <textarea id="edit-note-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                
                <div class="flex items-center gap-4">
                    <label for="edit-image-input" class="cursor-pointer p-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i>
                        <span>Resmi DeÄŸiÅŸtir (Max 250KB)</span>
                    </label>
                    <input type="file" id="edit-image-input" class="hidden" accept="image/*">
                    <div id="edit-image-preview-container" class="hidden items-center gap-2">
                        <img id="edit-image-preview" src="" alt="Resim Ã–nizleme" class="w-12 h-12 object-cover rounded-lg border">
                        <button id="edit-remove-image-btn" class="p-1 text-red-500 hover:bg-red-100 rounded-full" title="Resmi KaldÄ±r">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="date" id="edit-note-date-input" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 sm:w-1/2">
                    <select id="edit-note-category-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white sm:w-1/2">
                        <option value="Ä°ÅŸ">Ä°ÅŸ</option>
                        <option value="KiÅŸisel">KiÅŸisel</option>
                        <option value="Market">Market</option>
                    </select>
                </div>
                
                <select id="edit-note-priority-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                    <option value="Normal">Ã–ncelik: Normal</option>
                    <option value="YÃ¼ksek">Ã–ncelik: YÃ¼ksek</option>
                    <option value="DÃ¼ÅŸÃ¼k">Ã–ncelik: DÃ¼ÅŸÃ¼k</option>
                </select>

            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-note-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Ä°ptal</button>
                <button id="save-edit-note-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Bildirim Ayarlama ModalÄ± -->
    <div id="notification-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0 hidden">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Bildirim Ayarla</h3>
            <p class="text-gray-600 mb-4">Bu not iÃ§in ne zaman hatÄ±rlatma istersiniz?</p>
            <div class="flex items-center space-x-2">
                <input type="number" id="notification-time" min="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="5" value="5">
                <select id="notification-unit" class="p-2 border border-gray-300 rounded-lg">
                    <option value="minutes">dakika sonra</option>
                    <option value="hours">saat sonra</option>
                    <option value="days">gÃ¼n sonra</option>
                </select>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-notification-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Ä°ptal</button>
                <button id="save-notification-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Kaydet</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-sm text-gray-500 py-4 mt-8">
        Â© GÃ¶khan ELGÃœL tarafÄ±ndan tasarlanmÄ±ÅŸtÄ±r.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let allNotes = [];
            let currentNoteForNotification = null;
            let activeCategoryFilter = 'TÃ¼mÃ¼';
            let currentBase64Image = null; // Add modal iÃ§in
            let currentBase64ImageEdit = null; // Edit modal iÃ§in
            let currentEditingNoteId = null; // YENÄ°
            const IMAGE_MAX_SIZE = 250 * 1024; // 250KB limit
            
            // Kategori Renk EÅŸlemesi (Sadece etiket ve filtre iÃ§in)
            const categoryClasses = {
                'Ä°ÅŸ': { label: 'cat-label-Ä°ÅŸ', filter: 'cat-filter-Ä°ÅŸ' },
                'KiÅŸisel': { label: 'cat-label-KiÅŸisel', filter: 'cat-filter-KiÅŸisel' },
                'Market': { label: 'cat-label-Market', filter: 'cat-filter-Market' }
            };
            const defaultCategory = 'KiÅŸisel';

            // YENÄ°: Ã–ncelik EÅŸlemesi
            const priorityClasses = {
                'YÃ¼ksek': { border: 'priority-YÃ¼ksek', color: 'text-red-500' },
                'Normal': { border: 'priority-Normal', color: 'text-blue-500' },
                'DÃ¼ÅŸÃ¼k': { border: 'priority-DÃ¼ÅŸÃ¼k', color: 'text-gray-500' }
            };
            const priorityIcons = {
                'YÃ¼ksek': 'ðŸ”¥',
                'Normal': 'ðŸ”µ',
                'DÃ¼ÅŸÃ¼k': 'ðŸ”½'
            };
            const defaultPriority = 'Normal';

            // DOM Elements
            const noteList = document.getElementById('note-list');
            const statusIndicator = document.getElementById('status-indicator');
            const remindersContainer = document.getElementById('reminders-container');
            const categoryFiltersContainer = document.getElementById('category-filters');
            const searchInput = document.getElementById('search-input'); // YENÄ°

            // Add Note Modal Elements
            const addNoteModal = document.getElementById('add-note-modal');
            const openAddNoteModalBtn = document.getElementById('open-add-note-modal');
            const cancelAddNoteBtn = document.getElementById('cancel-add-note-btn');
            const addNoteBtn = document.getElementById('add-note-btn');
            const noteInput = document.getElementById('note-input');
            const noteDateInput = document.getElementById('note-date-input');
            const noteCategoryInput = document.getElementById('note-category-input');
            const notePriorityInput = document.getElementById('note-priority-input'); // YENÄ°
            const imageInput = document.getElementById('image-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');

            // YENÄ°: Edit Note Modal Elements
            const editNoteModal = document.getElementById('edit-note-modal');
            const cancelEditNoteBtn = document.getElementById('cancel-edit-note-btn');
            const saveEditNoteBtn = document.getElementById('save-edit-note-btn');
            const editNoteInput = document.getElementById('edit-note-input');
            const editNoteDateInput = document.getElementById('edit-note-date-input');
            const editNoteCategoryInput = document.getElementById('edit-note-category-input');
            const editNotePriorityInput = document.getElementById('edit-note-priority-input');
            const editImageInput = document.getElementById('edit-image-input');
            const editImagePreviewContainer = document.getElementById('edit-image-preview-container');
            const editImagePreview = document.getElementById('edit-image-preview');
            const editRemoveImageBtn = document.getElementById('edit-remove-image-btn');


            // Ses TanÄ±ma
            const startSpeechBtn = document.getElementById('start-speech-btn');
            let recognition;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let isRecording = false;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                startSpeechBtn.style.display = 'none';
                console.warn("TarayÄ±cÄ±nÄ±z ses tanÄ±mayÄ± desteklemiyor.");
            }

            // Completed Notes Elements
            const completedNotesToggle = document.getElementById('completed-notes-toggle');
            const completedChevron = document.getElementById('completed-chevron');
            const completedNotesPanel = document.getElementById('completed-notes-panel');
            const completedNoteList = document.getElementById('completed-note-list');
            const completedCount = document.getElementById('completed-count');
            
            // Notification Modal Elements
            const notificationModal = document.getElementById('notification-modal');
            const notificationTimeInput = document.getElementById('notification-time');
            const notificationUnitSelect = document.getElementById('notification-unit');
            const saveNotificationBtn = document.getElementById('save-notification-btn');
            const cancelNotificationBtn = document.getElementById('cancel-notification-btn');

            const tokenPart1 = 'ghp_2KS6iY7t1ka6bK';
            const tokenPart2 = 'yHwONJkXdwOUVhrU';
            const tokenPart3 = '3PqlSX';
            
            const GITHUB_CONFIG = {
                token: tokenPart1 + tokenPart2 + tokenPart3,
                owner: 'gokhangeo',
                repo: 'NOT',
                path: 'notes.json'
            };

            function init() {
                fetchNotesFromGitHub();
                
                // Add Note Modal Listeners
                openAddNoteModalBtn.addEventListener('click', openAddNoteModal);
                cancelAddNoteBtn.addEventListener('click', closeAddNoteModal);
                addNoteBtn.addEventListener('click', addNote);
                addNoteModal.addEventListener('click', (e) => { if (e.target === addNoteModal) closeAddNoteModal(); });
                imageInput.addEventListener('change', (e) => handleImageUpload(e, 'add'));
                removeImageBtn.addEventListener('click', () => removeImage('add'));

                // YENÄ°: Edit Note Modal Listeners
                cancelEditNoteBtn.addEventListener('click', closeEditModal);
                saveEditNoteBtn.addEventListener('click', saveEditNote);
                editNoteModal.addEventListener('click', (e) => { if (e.target === editNoteModal) closeEditModal(); });
                editImageInput.addEventListener('change', (e) => handleImageUpload(e, 'edit'));
                editRemoveImageBtn.addEventListener('click', () => removeImage('edit'));

                // YENÄ°: Search Listener
                searchInput.addEventListener('input', renderAll);

                // Ses TanÄ±ma Listeners
                if (SpeechRecognition) {
                    startSpeechBtn.addEventListener('click', toggleSpeechRecognition);
                    recognition.onstart = () => {
                        isRecording = true;
                        startSpeechBtn.classList.add('bg-red-500', 'text-white');
                        startSpeechBtn.innerHTML = '<i data-lucide="mic-off" class="w-5 h-5"></i>';
                        lucide.createIcons();
                    };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        noteInput.value = transcript;
                    };
                    recognition.onerror = (event) => {
                        console.error("Ses tanÄ±ma hatasÄ±:", event.error);
                        if(event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                            showStatus("LÃ¼tfen mikrofon izni verin.", true);
                        } else {
                            showStatus("Ses anlaÅŸÄ±lamadÄ±", true);
                        }
                    };
                    recognition.onend = () => {
                        isRecording = false;
                        startSpeechBtn.classList.remove('bg-red-500', 'text-white');
                        startSpeechBtn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
                        lucide.createIcons();
                    };
                }

                // Notification Modal Listeners
                saveNotificationBtn.addEventListener('click', saveNotification);
                cancelNotificationBtn.addEventListener('click', closeNotificationModal);
                notificationModal.addEventListener('click', (e) => { if (e.target === notificationModal) closeNotificationModal(); });
                
                addGlobalCompletedNotesEventListeners();

                completedNotesToggle.addEventListener('click', () => {
                    completedNotesPanel.classList.toggle('hidden');
                    completedChevron.classList.toggle('rotate-180');
                });

                if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
                
                lucide.createIcons();
            }
            
            function openAddNoteModal() {
                addNoteModal.classList.remove('hidden');
                setTimeout(() => addNoteModal.classList.add('open'), 10);
                
                // Formu sÄ±fÄ±rla
                noteInput.value = '';
                noteDateInput.value = '';
                noteCategoryInput.value = 'KiÅŸisel';
                notePriorityInput.value = 'Normal';
                removeImage('add');
            }
            
            function closeAddNoteModal() {
                addNoteModal.classList.remove('open');
                setTimeout(() => addNoteModal.classList.add('hidden'), 300);
            }
            
            function formatDateForDisplay(dateString) {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}.${month}.${year}`;
            }

            function renderAll() {
                renderCategories();
                renderNotes();
                renderReminders();
                renderGlobalCompletedNotes();
                lucide.createIcons(); // Ä°konlarÄ± yeniden render et
            }
            
            function toggleSpeechRecognition() {
                if (isRecording) {
                    recognition.stop();
                    isRecording = false;
                } else {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error("Mikrofon baÅŸlatÄ±lamadÄ± (muhtemelen zaten aÃ§Ä±ktÄ±):", e);
                    }
                }
            }

            function handleImageUpload(event, mode = 'add') {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > IMAGE_MAX_SIZE) {
                    showStatus(`Resim 250KB'den bÃ¼yÃ¼k olamaz.`, true);
                    if (mode === 'add') {
                        imageInput.value = null;
                    } else {
                        editImageInput.value = null;
                    }
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    if (mode === 'add') {
                        currentBase64Image = e.target.result;
                        imagePreview.src = currentBase64Image;
                        imagePreviewContainer.classList.remove('hidden');
                        imagePreviewContainer.classList.add('flex');
                    } else {
                        currentBase64ImageEdit = e.target.result;
                        editImagePreview.src = currentBase64ImageEdit;
                        editImagePreviewContainer.classList.remove('hidden');
                        editImagePreviewContainer.classList.add('flex');
                    }
                };
                reader.readAsDataURL(file);
            }

            function removeImage(mode = 'add') {
                if (mode === 'add') {
                    currentBase64Image = null;
                    imageInput.value = null;
                    imagePreview.src = '';
                    imagePreviewContainer.classList.add('hidden');
                    imagePreviewContainer.classList.remove('flex');
                } else {
                    // DÃ¼zenleme modunda, resmi kaldÄ±rmak null olarak ayarlamaktÄ±r.
                    currentBase64ImageEdit = null; 
                    editImageInput.value = null;
                    editImagePreview.src = '';
                    editImagePreviewContainer.classList.add('hidden');
                    editImagePreviewContainer.classList.remove('flex');
                }
            }
            
            function renderCategories() {
                const categories = ['Ä°ÅŸ', 'KiÅŸisel', 'Market'];
                categoryFiltersContainer.innerHTML = '';
                
                ['TÃ¼mÃ¼', ...categories].forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    
                    let categoryClass = '';
                    if (category !== 'TÃ¼mÃ¼') {
                        categoryClass = categoryClasses[category]?.filter || '';
                    }

                    button.className = `category-filter px-4 py-2 text-sm font-medium rounded-full ${categoryClass} ${category === activeCategoryFilter ? 'active' : 'bg-white text-gray-700 hover:bg-gray-50 shadow'}`;
                    button.dataset.category = category;
                    button.addEventListener('click', () => {
                        activeCategoryFilter = category;
                        renderAll();
                    });
                    categoryFiltersContainer.appendChild(button);
                });
            }

            function renderNotes() {
                noteList.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase(); // YENÄ°

                const activeNotes = allNotes.filter(note => {
                    const matchesCategory = activeCategoryFilter === 'TÃ¼mÃ¼' || (note.category || defaultCategory) === activeCategoryFilter;
                    const matchesSearch = !searchTerm || note.text.toLowerCase().includes(searchTerm);
                    const isDone = note.done;
                    return !isDone && matchesCategory && matchesSearch;
                });

                if (activeNotes.length === 0) {
                    const message = searchTerm ? 'Arama sonucuyla eÅŸleÅŸen not yok.' : 'Bu kategoride aktif not yok.';
                    noteList.innerHTML = `<li class="text-center text-gray-500 p-4 col-span-1 md:col-span-2 lg:col-span-3">${message}</li>`;
                } else {
                    activeNotes.forEach((note) => {
                        const li = document.createElement('li');
                        const category = note.category || defaultCategory;
                        const priority = note.priority || defaultPriority;
                        
                        const catLabel = categoryClasses[category]?.label || categoryClasses[defaultCategory].label;
                        const priorityClass = priorityClasses[priority]?.border || priorityClasses[defaultPriority].border;
                        const priorityIcon = priorityIcons[priority] || priorityIcons[defaultPriority];
                        const priorityColor = priorityClasses[priority]?.color || priorityClasses[defaultPriority].color;

                        li.className = `note-card flex flex-col justify-between bg-white rounded-lg shadow-md ${priorityClass} overflow-hidden`;
                        li.dataset.id = note.id;
                        li.innerHTML = `
                            ${note.image ? `<img src="${note.image}" alt="Not GÃ¶rseli" class="w-full h-32 object-cover">` : ''}
                            <div class="p-4 flex-grow flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-xs font-semibold ${catLabel} text-white px-2 py-0.5 rounded-full inline-block">${category}</span>
                                        <span class="text-lg ${priorityColor}" title="Ã–ncelik: ${priority}">${priorityIcon}</span>
                                    </div>
                                    <p class="note-text text-gray-800 mb-4">${note.text}</p>
                                </div>
                                <div class="flex items-center justify-between text-gray-500">
                                    <span class="text-xs font-medium flex items-center">
                                        <i data-lucide="calendar" class="w-3.5 h-3.5 mr-1.5"></i>
                                        ${formatDateForDisplay(note.date) || 'Tarih yok'}
                                    </span>
                                    <div class="flex items-center space-x-1">
                                        <!-- YENÄ°: DÃ¼zenle Butonu -->
                                        <button class="edit-btn p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-blue-500 transition" title="DÃ¼zenle">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button class="notification-btn p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-indigo-500 transition" title="HatÄ±rlatma Kur">
                                            <i data-lucide="bell" class="w-4 h-4"></i>
                                        </button>
                                        <button class="delete-btn p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition" title="Sil">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        li.querySelector('.delete-btn').addEventListener('click', () => deleteNote(note.id, li));
                        li.querySelector('.notification-btn').addEventListener('click', () => openNotificationModal(note.id));
                        li.querySelector('.edit-btn').addEventListener('click', () => openEditModal(note.id)); // YENÄ°
                        noteList.appendChild(li);
                    });
                }
            }
            
            function renderGlobalCompletedNotes() {
                completedNoteList.innerHTML = '';
                const allCompletedNotes = allNotes.filter(note => note.done);

                const completedAccordion = document.getElementById('completed-notes-accordion');
                if (allCompletedNotes.length > 0) {
                    completedAccordion.classList.remove('hidden');
                    completedCount.textContent = allCompletedNotes.length;
                    
                    allCompletedNotes.forEach(note => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm';
                        li.dataset.id = note.id;
                        li.innerHTML = `
                            <span class="text-gray-500 line-through">${note.text} <span class"text-xs font-medium">(${note.category || defaultCategory})</span></span>
                            <div class="flex items-center space-x-2">
                                <button class="reopen-btn p-1.5 text-blue-500 hover:bg-blue-100 rounded-full" title="Yeniden AÃ§">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                </button>
                                <button class="delete-btn-completed p-1.5 text-red-500 hover:bg-red-100 rounded-full" title="Sil">
                                     <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                        completedNoteList.appendChild(li);
                    });
                } else {
                    completedAccordion.classList.add('hidden');
                }
            }
            
            function addGlobalCompletedNotesEventListeners() {
                completedNoteList.addEventListener('click', (e) => {
                    const li = e.target.closest('li[data-id]');
                    if (!li) return;
                    const id = li.dataset.id;

                    if (e.target.closest('.reopen-btn')) {
                        toggleDone(id, false, null);
                    }
                    if (e.target.closest('.delete-btn-completed')) {
                        deleteNote(id, null);
                    }
                });
            }

            function renderReminders() {
                remindersContainer.innerHTML = '';
                const getFormattedDate = (date) => date.toISOString().split('T')[0];
                const todayStr = getFormattedDate(new Date());
                const tomorrowStr = getFormattedDate(new Date(Date.now() + 86400000));

                const todayNotes = allNotes.filter(note => !note.done && note.date === todayStr);
                const tomorrowNotes = allNotes.filter(note => !note.done && note.date === tomorrowStr);

                if (todayNotes.length > 0) {
                    const card = createReminderCard('BugÃ¼nÃ¼n NotlarÄ±', todayNotes, 'yellow');
                    remindersContainer.appendChild(card);
                }
                if (tomorrowNotes.length > 0) {
                    const card = createReminderCard('YarÄ±nÄ±n NotlarÄ±', tomorrowNotes, 'blue');
                    remindersContainer.appendChild(card);
                }
            }

            function createReminderCard(title, notes, color) {
                const card = document.createElement('div');
                const colors = {
                    yellow: { bg: 'bg-yellow-50', border: 'border-yellow-400', text: 'text-yellow-800' },
                    blue: { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-800' }
                };
                card.className = `${colors[color].bg} border-l-4 ${colors[color].border} ${colors[color].text} p-4 rounded-lg shadow-sm`;
                
                let listItems = notes.map(note => `
                    <li class"mt-1 flex items-center">
                        <span class="font-semibold">${note.category || defaultCategory}:</span>
                        <span class="ml-2">${note.text}</span>
                    </li>
                `).join('');

                card.innerHTML = `
                    <h3 class"font-bold text-lg flex items-center"><i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>${title}</h3>
                    <ul class="list-disc list-inside ml-2 mt-2 space-y-1">${listItems}</ul>
                `;
                return card;
            }

            function addNote() {
                const text = noteInput.value.trim();
                const date = noteDateInput.value;
                const category = noteCategoryInput.value;
                const priority = notePriorityInput.value; // YENÄ°
                
                if (text) {
                    const newNote = { 
                        id: Date.now().toString(), 
                        text, 
                        date, 
                        category, 
                        priority, // YENÄ°
                        image: currentBase64Image,
                        done: false, 
                        reminderId: null 
                    };
                    allNotes.unshift(newNote);
                    saveNotes();
                    renderAll();
                    closeAddNoteModal();
                }
            }

            // YENÄ°: Not DÃ¼zenleme FonksiyonlarÄ±
            function openEditModal(id) {
                const note = allNotes.find(n => n.id === id);
                if (!note) return;

                currentEditingNoteId = id;
                
                editNoteInput.value = note.text;
                editNoteDateInput.value = note.date || '';
                editNoteCategoryInput.value = note.category || defaultCategory;
                editNotePriorityInput.value = note.priority || defaultPriority;
                
                // Resmi ayarla
                currentBase64ImageEdit = note.image || null;
                if (note.image) {
                    editImagePreview.src = note.image;
                    editImagePreviewContainer.classList.remove('hidden');
                    editImagePreviewContainer.classList.add('flex');
                } else {
                    removeImage('edit');
                }

                editNoteModal.classList.remove('hidden');
                setTimeout(() => editNoteModal.classList.add('open'), 10);
            }

            function closeEditModal() {
                editNoteModal.classList.remove('open');
                setTimeout(() => editNoteModal.classList.add('hidden'), 300);
                currentEditingNoteId = null;
                currentBase64ImageEdit = null;
                editImageInput.value = null;
            }

            function saveEditNote() {
                if (!currentEditingNoteId) return;

                const noteIndex = allNotes.findIndex(n => n.id === currentEditingNoteId);
                if (noteIndex === -1) return;

                const text = editNoteInput.value.trim();
                if (!text) {
                    showStatus("Not metni boÅŸ olamaz.", true);
                    return;
                }

                const updatedNote = {
                    ...allNotes[noteIndex],
                    text: text,
                    date: editNoteDateInput.value,
                    category: editNoteCategoryInput.value,
                    priority: editNotePriorityInput.value,
                    image: currentBase64ImageEdit // Bu, 'removeImage' ile null yapÄ±lmÄ±ÅŸ olabilir veya yeni resimle gÃ¼ncellenmiÅŸ olabilir
                };

                allNotes[noteIndex] = updatedNote;
                saveNotes();
                renderAll();
                closeEditModal();
                showStatus("Not gÃ¼ncellendi", false);
            }

            function toggleDone(id, isDone, element) {
                const note = allNotes.find(n => n.id == id);
                if (note) {
                    note.done = isDone;
                    
                    const action = () => {
                        saveNotes();
                        renderAll();
                    };

                    if (element) {
                        element.classList.add('exiting');
                        setTimeout(action, 300);
                    } else {
                        action();
                    }
                }
            }

            function deleteNote(id, element) {
                const noteIndex = allNotes.findIndex(n => n.id == id);
                if (noteIndex > -1) {
                    const note = allNotes[noteIndex];
                    if (note.reminderId) clearTimeout(note.reminderId);
                    
                    const action = () => {
                        allNotes.splice(noteIndex, 1);
                        saveNotes();
                        renderAll();
                    };
                    
                    if (element) {
                        element.classList.add('exiting');
                        setTimeout(action, 300);
                    } else {
                        action();
                    }
                }
            }

            function openNotificationModal(id) {
                currentNoteForNotification = id;
                notificationModal.classList.remove('hidden');
                setTimeout(() => notificationModal.classList.add('open'), 10);
                notificationTimeInput.value = '5';
                notificationUnitSelect.value = 'minutes';
            }

            function closeNotificationModal() {
                 notificationModal.classList.remove('open');
                setTimeout(() => notificationModal.classList.add('hidden'), 300);
                 currentNoteForNotification = null;
            }

            function saveNotification() {
                if (currentNoteForNotification === null) return;
                
                const note = allNotes.find(n => n.id == currentNoteForNotification);
                if (!note) return;

                const time = parseInt(notificationTimeInput.value);
                const unit = notificationUnitSelect.value;

                if (!time || time <= 0) {
                    showStatus('LÃ¼tfen geÃ§erli bir zaman girin.', true);
                    return;
                }
                if (Notification.permission !== 'granted') {
                    showStatus('LÃ¼tfen bildirimlere izin verin.', true);
                    return;
                }

                let delay = 0;
                if (unit === 'minutes') delay = time * 60 * 1000;
                else if (unit === 'hours') delay = time * 3600 * 1000;
                else if (unit === 'days') delay = time * 86400 * 1000;

                if(note.reminderId) clearTimeout(note.reminderId);

                note.reminderId = setTimeout(() => {
                    new Notification('Not HatÄ±rlatma', { body: note.text, icon: 'https://placehold.co/48x48/667eea/ffffff?text=N' });
                    note.reminderId = null;
                    saveNotes();
                }, delay);
                
                saveNotes();
                closeNotificationModal();
                showStatus("HatÄ±rlatma kuruldu", false);
            }

            function showStatus(message, isError = false) {
                statusIndicator.textContent = message;
                statusIndicator.className = `absolute top-4 right-4 text-xs font-semibold px-2 py-1 rounded-full opacity-100 ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                setTimeout(() => {
                    statusIndicator.classList.remove('opacity-100');
                    statusIndicator.classList.add('opacity-0');
                }, 3000);
            }

            function loadNotesFromLocalStorage() {
                const savedNotes = localStorage.getItem('mersinNotes');
                if (savedNotes) {
                    let data = JSON.parse(savedNotes);
                    if (Array.isArray(data)) {
                        allNotes = data;
                    } else {
                        allNotes = [];
                    }
                } else {
                    allNotes = [];
                }
                renderAll();
            }

            function saveNotes() {
                localStorage.setItem('mersinNotes', JSON.stringify(allNotes));
                saveNotesToGitHub(); 
            }
            
            async function fetchNotesFromGitHub() {
                if (!GITHUB_CONFIG.token) {
                    loadNotesFromLocalStorage(); return;
                }
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`, 'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (response.status === 404) {
                        loadNotesFromLocalStorage(); return;
                    }
                     if (response.status === 401) {
                        showStatus("GeÃ§ersiz API AnahtarÄ±", true);
                        loadNotesFromLocalStorage(); return;
                    }
                    if (!response.ok) throw new Error(`GitHub API HatasÄ±: ${response.statusText}`);
                    
                    const data = await response.json();
                    const decodedContent = decodeURIComponent(escape(window.atob(data.content)));
                    let notesData = JSON.parse(decodedContent);

                    if (Array.isArray(notesData)) {
                        allNotes = notesData;
                    } else {
                        allNotes = [];
                    }
                    
                    renderAll();
                    showStatus("Notlar GitHub'dan yÃ¼klendi");
                } catch (error) {
                    console.error("GitHub'dan notlar alÄ±namadÄ±:", error);
                    showStatus("Notlar yÃ¼klenemedi", true);
                    loadNotesFromLocalStorage();
                }
            }
            
            async function saveNotesToGitHub() {
                if (!GITHUB_CONFIG.token) return;
                try {
                    let sha;
                    const getFileResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                         headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                    });
                    if(getFileResponse.ok) sha = (await getFileResponse.json()).sha;

                    const contentToEncode = JSON.stringify(allNotes, null, 2);
                    const encodedContent = window.btoa(unescape(encodeURIComponent(contentToEncode)));

                    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`, 'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: `Notlar gÃ¼ncellendi: ${new Date().toISOString()}`,
                            content: encodedContent,
                            sha: sha
                        })
                    });
                     if (response.status === 401) {
                        showStatus("GeÃ§ersiz API AnahtarÄ±", true);
                        return;
                    }
                    if (!response.ok) throw new Error(`GitHub API HatasÄ±: ${response.statusText}`);
                    showStatus("Notlar GitHub'a kaydedildi");
                } catch (error) {
                    console.error("Notlar GitHub'a kaydedilemedi:", error);
                    showStatus("KayÄ±t baÅŸarÄ±sÄ±z", true);
                }
            }
            
            init();
        });
    </script>
</body>
</html>
